/*!
 * ramsondon.github.io - xng.js v1.0.0 (https://ramsondon.github.io/xng)
 * Copyright 2017 -2017 Matthias Schimd <ramsondon@gmail.com> (https://ramsondon.github.io)
 * Licensed under MIT (https://github.com/ramsondon/xng/blob/master/LICENSE)
 */
_&&"undefined"!=typeof _||(_={}),_.xng=function(){var t=function(){this.attributes={view:"data-xng-view",model:"data-xng-model",listen:"data-xng-listen"},this.templateSettings={escape:/{{\\([\s\S]+?)}}/g,evaluate:/{%([\s\S]+?)%}/g,interpolate:/{{([\s\S]+?)}}/g},this.base_route="",this.wait_cache_freq=0,this.model_cache={mark:{},cache:{}},this.tpl_cache={mark:{},cache:{}},this.listeners={}};return t.prototype.fetch=function(t,e){return new Promise(function(n,i){var r=_.trimEnd(this.base_route,"/")+"/"+_.trimStart(t,"/");fetch(r).then(function(t){if(200!==t.status)return void i("Error Report","Status Code: "+t.status,t.statusText);t[e]().then(function(t){n(t)}.bind(this))}.bind(this)).catch(function(t){i(t)}.bind(this))}.bind(this))},t.prototype.toKey=function(t){return t.replace(new RegExp("[/.-]","g"),"_")},t.prototype.waitCache=function(t,e){return new Promise(function(n){var i=0,r=function(){i>0&&e in t?(clearTimeout(i),i=0,n(e)):i=setTimeout(r,this.wait_cache_freq)}.bind(this);i=setTimeout(r,this.wait_cache_freq)}.bind(this))},t.prototype.render=function(t,e,n,i){return new Promise(function(r){var s=function(t){var s=document.createElement("script");s.type="text/x-xng-tpl",s.innerHTML=t,n.appendChild(s),n.innerHTML=_.template(n.innerHTML)(e),n.innerHTML=n.querySelector("script").innerHTML,this.include(n.querySelectorAll("["+this.attributes.view+"]")).then(function(){r(),_.isString(i)&&i in this.listeners&&this.listeners[i]()}.bind(this))}.bind(this);this.cacheResource(t,this.tpl_cache,"text").then(function(t){s(this.tpl_cache.cache[t])}.bind(this)).catch(function(t){console.warn(t)})}.bind(this))},t.prototype.put=function(t,e){document.querySelector(e).innerHTML=t},t.prototype.cacheResource=function(t,e,n){return new Promise(function(i){var r=this.toKey(t);r in e.mark?this.waitCache(e.cache,r).then(function(t){i(t)}.bind(this)):(e.mark[r]=t,this.fetch(t,n).then(function(t){e.cache[r]=t,i(r)}))}.bind(this))},t.prototype.parseDirectives=function(t){return{model:t.getAttribute(this.attributes.model),template:t.getAttribute(this.attributes.view),listener:t.getAttribute(this.attributes.listen)}},t.prototype.include=function(t){return new Promise(function(e,n){var i=0,r=function(n,r,s){this.render(n.template,{xngModel:r},s,n.listener).then(function(){++i===t.length&&e()}.bind(this))}.bind(this);_.forEach(t,function(t){var e=this.parseDirectives(t);if(e.model)try{r(e,this.readAssignment(e.model),t)}catch(n){this.cacheResource(e.model,this.model_cache,"json").then(function(n){r(e,this.model_cache.cache[n],t)}.bind(this)).catch(function(t){console.warn(t)})}else r(e,null,t)}.bind(this)),t.length<=0&&e()}.bind(this))},t.prototype.nl2br=function(t,e){if(_.isString(t)){return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(e||void 0===e?"<br />":"<br>")+"$2")}return t},t.prototype.assign=function(t){return _.escape(JSON.stringify(t))},t.prototype.readAssignment=function(t){return JSON.parse(_.unescape(t))},t.prototype.xng=function(){for(var t in this.templateSettings)_.templateSettings[t]=this.templateSettings[t];return this.include(document.querySelectorAll("["+this.attributes.view+"]"))},t.prototype.base=function(t){return this.base_route=t,this},t.prototype.listen=function(t,e){if(_.isObject(t)&&_.isUndefined(e))for(var n in t)this.listen(n,t[n]);else _.isString(t)&&_.isFunction(e)&&(this.listeners[t]=e);return this},t.prototype.require=function(t,e){return new Promise(function(n){var i=function(t,n,i,r){var s,o=i.replace(new RegExp("[/.:]","g"),"_"),c=t.getElementsByTagName(n)[0];if(!t.getElementById(o)){if(s=t.createElement(n),s.id=o,s.src=i,_.isString(e)&&s.setAttribute(e,""),_.isObject(e))for(var a in e)s.setAttribute(a,e[a]);if(_.isArray(e))for(var u=0;u<e.length;u++)s.setAttribute(e[u],"");c.parentNode.insertBefore(s,c),s.readyState?s.onreadystatechange=function(){"loaded"!==s.readyState&&"complete"!==s.readyState||(s.onreadystatechange=null,r(i))}:s.onload=function(){r(i)}}};_.isString(t)?i(document,"script",t,n):_.forEach(t,function(e,r){i(document,"script",e,function(){r===t.length-1&&n(t)})})}.bind(this))},new t}();
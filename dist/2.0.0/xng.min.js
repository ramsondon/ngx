/*!
 * ramsondon.github.io - xng.js v2.0.0 (https://ramsondon.github.io/xng)
 * Copyright 2017 -2017 Matthias Schimd <ramsondon@gmail.com> (https://ramsondon.github.io)
 * Licensed under MIT (https://github.com/ramsondon/xng/blob/master/LICENSE)
 */
!function(t,e){"function"==typeof define&&define.amd?define(["lodash"],e):"object"==typeof exports?module.exports=e(require("lodash")):t.Xng=e(t._)}(this,function(t){var e=function(){this.attributes={view:"data-xng-view",model:"data-xng-model",listen:"data-xng-listen"},this.templateSettings={escape:/{{\\([\s\S]+?)}}/g,evaluate:/{%([\s\S]+?)%}/g,interpolate:/{{([\s\S]+?)}}/g},this.base_route="",this.wait_cache_freq=0,this.model_cache={mark:{},cache:{}},this.tpl_cache={mark:{},cache:{}},this.listeners={}};return e.prototype.fetch=function(e,n){return new Promise(function(i,r){var s=t.trimEnd(this.base_route,"/")+"/"+t.trimStart(e,"/");fetch(s).then(function(t){if(200!==t.status)return void r("Error Report","Status Code: "+t.status,t.statusText);t[n]().then(function(t){i(t)}.bind(this))}.bind(this)).catch(function(t){r(t)}.bind(this))}.bind(this))},e.prototype.toKey=function(t){return t.replace(new RegExp("[/.-]","g"),"_")},e.prototype.waitCache=function(t,e){return new Promise(function(n){var i=0,r=function(){i>0&&e in t?(clearTimeout(i),i=0,n(e)):i=setTimeout(r,this.wait_cache_freq)}.bind(this);i=setTimeout(r,this.wait_cache_freq)}.bind(this))},e.prototype.render=function(e,n,i,r){return new Promise(function(s){var o=function(e){var o=document.createElement("script");o.type="text/x-xng-tpl",o.innerHTML=e,i.appendChild(o),i.innerHTML=t.template(i.innerHTML)(n),i.innerHTML=i.querySelector("script").innerHTML,this.include(i.querySelectorAll("["+this.attributes.view+"]")).then(function(){s(),t.isString(r)&&r in this.listeners&&this.listeners[r]()}.bind(this))}.bind(this);this.cacheResource(e,this.tpl_cache,"text").then(function(t){o(this.tpl_cache.cache[t])}.bind(this)).catch(function(t){console.warn(t)})}.bind(this))},e.prototype.put=function(t,e){document.querySelector(e).innerHTML=t},e.prototype.cacheResource=function(t,e,n){return new Promise(function(i){var r=this.toKey(t);r in e.mark?this.waitCache(e.cache,r).then(function(t){i(t)}.bind(this)):(e.mark[r]=t,this.fetch(t,n).then(function(t){e.cache[r]=t,i(r)}))}.bind(this))},e.prototype.parseDirectives=function(t){return{model:t.getAttribute(this.attributes.model),template:t.getAttribute(this.attributes.view),listener:t.getAttribute(this.attributes.listen)}},e.prototype.include=function(e){return new Promise(function(n,i){var r=0,s=function(t,i,s){this.render(t.template,{xngModel:i},s,t.listener).then(function(){++r===e.length&&n()}.bind(this))}.bind(this);t.forEach(e,function(t){var e=this.parseDirectives(t);if(e.model)try{s(e,this.readAssignment(e.model),t)}catch(n){this.cacheResource(e.model,this.model_cache,"json").then(function(n){s(e,this.model_cache.cache[n],t)}.bind(this)).catch(function(t){console.warn(t)})}else s(e,null,t)}.bind(this)),e.length<=0&&n()}.bind(this))},e.prototype.nl2br=function(e,n){if(t.isString(e)){return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(n||void 0===n?"<br />":"<br>")+"$2")}return e},e.prototype.assign=function(e){return t.escape(JSON.stringify(e))},e.prototype.readAssignment=function(e){return JSON.parse(t.unescape(e))},e.prototype.view=function(){for(var e in this.templateSettings)t.templateSettings[e]=this.templateSettings[e];return this.include(document.querySelectorAll("["+this.attributes.view+"]"))},e.prototype.base=function(t){return this.base_route=t,this},e.prototype.listen=function(e,n){if(t.isObject(e)&&t.isUndefined(n))for(var i in e)this.listen(i,e[i]);else t.isString(e)&&t.isFunction(n)&&(this.listeners[e]=n);return this},e.prototype.require=function(e,n){return new Promise(function(i){var r=function(e,i,r,s){var o,c=r.replace(new RegExp("[/.:]","g"),"_"),a=e.getElementsByTagName(i)[0];if(!e.getElementById(c)){if(o=e.createElement(i),o.id=c,o.src=r,t.isString(n)&&o.setAttribute(n,""),t.isObject(n))for(var u in n)o.setAttribute(u,n[u]);if(t.isArray(n))for(var h=0;h<n.length;h++)o.setAttribute(n[h],"");a.parentNode.insertBefore(o,a),o.readyState?o.onreadystatechange=function(){"loaded"!==o.readyState&&"complete"!==o.readyState||(o.onreadystatechange=null,s(r))}:o.onload=function(){s(r)}}};t.isString(e)?r(document,"script",e,i):t.forEach(e,function(t,n){r(document,"script",t,function(){n===e.length-1&&i(e)})})}.bind(this))},t.xng=new e,e});
/*!
 * ramsondon.github.io - xng.js v3.1.1 (https://ramsondon.github.io/xng)
 * Copyright 2017 -2017 Matthias Schimd <ramsondon@gmail.com> (https://ramsondon.github.io)
 * Licensed under MIT (https://github.com/ramsondon/xng/blob/master/LICENSE)
 */
!function(t,e){"function"==typeof define&&define.amd?define(["lodash"],e):"object"==typeof exports?module.exports=e(require("lodash")):t.Xng=e(t._)}(this,function(t){var e=function(){"use strict";return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},r=function(e,n,i){"use strict";if(t.isObject(n)&&t.isUndefined(i))for(var o in n)r(e,o,n[o]);else t.isString(n)&&t.isFunction(i)&&(e[n]=i)},n=function(e,r,i){"use strict";t.isString(r)&&r in e?e[r](r,i):t.isArray(r)&&t.forEach(r,function(t){n(e,t,i)}),"*"in e&&e["*"](r,i)},i=function(){this.memory={}};i.prototype.hit=function(t){return t in this.memory},i.prototype.fault=function(t){return!this.hit(t)},i.prototype.put=function(t,e){this.memory[t]=e},i.prototype.get=function(t){if(this.hit(t))return this.memory[t];throw new Error("cache fault")};var o=function(){this.marker=new i,this.memory=new i};o.prototype.cache=function(e,r){return new Promise(function(n,i){var o=t.snakeCase(e);this.marker.fault()&&this.marker.put(o,r.fetch(e)),this.marker.get(o).then(function(t){this.memory.fault(o)&&this.memory.put(o,t),n(o)}.bind(this),function(t){console.warn("resource not found: ",e,t),i(e,r)}).catch(function(){i(e,r)})}.bind(this))},o.prototype.get=function(t){return this.memory.get(t)};var s=function(t,e){"use strict";this.transformer=t||new c,this.url_prefix=e||""};s.prototype.parse=function(e){"use strict";return this.url_prefix.length>0?t.trimEnd(this.url_prefix,"/")+"/"+t.trimStart(e,"/"):e},s.prototype.fetch=function(t){return new Promise(function(e,r){var n=this.parse(t);fetch(n).then(function(t){if(200!==t.status)return console.warn("Error Report","Status Code: "+t.status,t.statusText),void r("Error Report","Status Code: "+t.status,t.statusText);t.text().then(function(t){this.transformer.transform(t).then(function(t){e(t)})}.bind(this))}.bind(this),r).catch(function(t){r(t)}.bind(this))}.bind(this))};var u=function(t,e){this.el=t||document.createElement("div"),this.model=e||{$model:{}},this.afterRenderHtmlListeners={}};u.prototype.renderHtml=function(e){var r=document.createElement("script");r.type="text/x-xng-tpl",r.innerHTML=e,this.el.appendChild(r),this.el.innerHTML=t.template(this.el.innerHTML)(this.model),this.el.innerHTML=this.el.querySelector("script").innerHTML,n(this.afterRenderHtmlListeners,"all",{el:this.el,model:this.model})},u.prototype.afterRenderHtml=function(t){r(this.afterRenderHtmlListeners,"all",t)};var a=function(){};a.prototype.doTransformation=function(t){return t},a.prototype.transform=function(t){return new Promise(function(e,r){try{e(this.doTransformation(t))}catch(e){r(t)}}.bind(this))};var c=function(){};c.prototype=Object.create(a.prototype);var h=function(){};h.prototype=Object.create(a.prototype),h.prototype.doTransformation=function(t){return JSON.parse(t)};var p=function(t){this.attribute=t,this.redirectOnInvalid=!0,this.routeMap={elements:[],routes:{}},this.listeners={}};p.prototype.current=function(){return this.normalize(this.read())},p.prototype.l=function(){return window.location},p.prototype.read=function(){return this.l().href},p.prototype.redirect=function(t){this.l().href=t},p.prototype.normalize=function(e){return t.trim(t.trim(e||""),"/")},p.prototype.parse=function(e){return e=e||"",e=t.split(e,","),e=t.compact(e),e.map(function(t){return this.normalize(t)}.bind(this))},p.prototype.select=function(t){return t.querySelectorAll("["+this.attribute+"]")},p.prototype.collect=function(e){var r=this.select(e);return t.forEach(r,function(e){if(!t.find(this.routeMap.elements,function(t){return t===e})){this.routeMap.elements.push(e);var r=e.getAttribute(this.attribute);this.parse(r).forEach(function(r){r in this.routeMap.routes||(this.routeMap.routes[r]={route:r,elements:[]}),t.find(this.routeMap.routes[r].elements,function(t){return t===e})||this.routeMap.routes[r].elements.push(e)}.bind(this))}}.bind(this)),r.length},p.prototype.link=function(t){return t},p.prototype.listen=function(){var e=this.current(),r=function(t){return t in this.routeMap.routes}.bind(this),i=function(t){if(this.routeMap.elements.length>0&&t in this.routeMap.routes){var e=this.routeMap.routes[t];this.routeMap.elements.forEach(function(t){t.style.display="none"}),e.elements.forEach(function(t){t.style.display=""}),n(this.listeners,e.routes)}}.bind(this);r(e)?i(e):e.length<=0&&r(".")?i("."):e.length<=0?i(t.first(this.routeMap.routes)):this.redirectOnInvalid&&this.redirect("")};var f=function(t){p.call(this,t)};f.prototype=Object.create(p.prototype),f.prototype.read=function(){return this.l().hash},f.prototype.normalize=function(e){return t.trimStart(p.prototype.normalize.apply(this,arguments),"#")},f.prototype.redirect=function(t){this.l().hash=t},f.prototype.link=function(t){return"#"+t},f.prototype.listen=function(){p.prototype.listen.apply(this,arguments),window.onhashchange=function(){p.prototype.listen.apply(this,arguments)}.bind(this)};var l=function(t){p.call(this,t),this.param="page"};l.prototype=Object.create(p.prototype),l.prototype.read=function(){var t=this.getQueryObject();return this.param in t?t.page:""},l.prototype.normalize=function(e){return t.trimStart(p.prototype.normalize.apply(this,arguments),"?")},l.prototype.redirect=function(t){this.l().search=t},l.prototype.getQueryObject=function(){var t=decodeURIComponent(this.l().search.substring(1));return t.length<=0?{}:JSON.parse('{"'+t.replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')},l.prototype.toQueryString=function(t,e){var r,n=[];for(r in t)if(t.hasOwnProperty(r)){var i=e?e+"["+r+"]":r,o=t[r];n.push(null!==o&&"object"==typeof o?this.toQueryString(o,i):encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")},l.prototype.link=function(t){var e=this.getQueryObject();return e[this.param]=t,"?"+this.toQueryString(e)+this.l().hash},l.prototype.listen=function(){p.prototype.listen.apply(this,arguments)};var d=function(){this.ROUTER_FACTORY={HashRouter:f,QueryRouter:l},this.ASSIGNMENT_SYMBOL="/xng.assignment."+this.guid()+"/",this.transformers={text:new c,json:new h},this.defaultModelTransformer="json",this.attributes={view:"data-xng-view",model:"data-xng-model",listen:"data-xng-listen",route:"data-xng-route",transform:"data-xng-transform"},this.templateSettings={escape:/{{\\([\s\S]+?)}}/g,evaluate:/{%([\s\S]+?)%}/g,interpolate:/{{([\s\S]+?)}}/g},this.base_remote_dir="",this.model_cache=new o,this.tpl_cache=new o,this.router=new f(this.attributes.route),this.listeners={view:{}},this.errorTemplate='<div class="error"><h4>{{ $model.title }}</h4><p>{{ $model.message }}</p></div>'};return d.prototype.createTransformer=function(t){var e=function(){};return e.prototype=Object.create(this.defaultTransformer().prototype),e.prototype.doTransformation=t,e},d.prototype.defaultTransformer=function(){return a},d.prototype.using=function(t){var e=this.ROUTER_FACTORY[t];return this.router=new e(this.attributes.route),this},d.prototype.link=function(t){return this.router.link(t)},d.prototype.fetch=function(t,e){return new s(this.transformers[e],this.base_remote_dir).fetch(t)},d.prototype.render=function(e,r,i,o){return new Promise(function(a){var c=new u(i,r);c.afterRenderHtml(function(){var t=i.querySelectorAll("["+this.attributes.view+"]");this.include(t).then(function(){a(),n(this.listeners.view,o,i)}.bind(this))}.bind(this)),this.tpl_cache.cache(e,new s(this.transformers.text,this.base_remote_dir)).then(function(t){c.renderHtml(this.tpl_cache.get(t))}.bind(this),function(n,i){c.model=t.cloneDeep(r),c.model.$model={title:"resource not found",message:"resource "+e+" could not be loaded!"},c.renderHtml(this.errorTemplate),console.warn("resource not found: ",e)}.bind(this)).catch(function(t){console.warn("error has been catched",t)})}.bind(this))},d.prototype.put=function(t,e,r){var i=document.querySelector(e);i.innerHTML=t,n(this.listeners.view,r,i)},d.prototype.guid=function(){var t=e;return[t()+t(),t(),t(),t(),t()+t()+t()].join("-")},d.prototype.parseDirectives=function(t){return{model:t.getAttribute(this.attributes.model),template:t.getAttribute(this.attributes.view),listener:t.getAttribute(this.attributes.listen),transform:t.getAttribute(this.attributes.transform)||this.defaultModelTransformer}},d.prototype.include=function(e){return new Promise(function(r){var n=0,i=function(){++n===e.length&&r()},o=function(t,e,r){this.render(t.template,{$route:this.router.current(),$model:e},r,t.listener).then(i.bind(this))}.bind(this);t.forEach(e,function(t){var e=this.parseDirectives(t);e.model?this.readAssignment(e.model,this.transformers[e.transform]).then(function(r){o(e,r,t)},function(){var r=new s(this.transformers[e.transform],this.base_remote_dir);this.model_cache.cache(e.model,r).then(function(r){o(e,this.model_cache.get(r),t)}.bind(this),function(r){o(e,{},t),console.warn("model resource not found: ",r)}.bind(this)).catch(function(t){console.warn(t)})}.bind(this)):o(e,null,t)}.bind(this)),e.length<=0&&r()}.bind(this))},d.prototype.nl2br=function(e,r){if(t.isString(e)){return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(r||void 0===r?"<br />":"<br>")+"$2")}return e},d.prototype.assign=function(e){return t.escape(this.ASSIGNMENT_SYMBOL+JSON.stringify(t.toPlainObject(e)))},d.prototype.readAssignment=function(e,r){var n=t.unescape(e);return t.startsWith(n,this.ASSIGNMENT_SYMBOL)?(n=n.replace(this.ASSIGNMENT_SYMBOL,""),r.transform(n)):new Promise(function(t,e){e(n)})},d.prototype.base=function(t){return this.base_remote_dir=t,this},d.prototype.route=function(t,e){return r(this.router.listeners,t,e),this},d.prototype.transform=function(e,r){if(t.isString(e)&&t.isFunction(r)){var n=this.createTransformer(r);this.transform(e,new n)}else if(t.isObject(e)&&t.isUndefined(r))for(var i in e)this.transform(i,e[i]);else t.isString(e)&&!t.isUndefined(r)&&(this.transformers[e]=r);return this},d.prototype.listen=function(t,e){return r(this.listeners.view,t,e),this},d.prototype.require=function(e,r){return new Promise(function(n){var i=function(e,n,i,o){var s,u=i.replace(new RegExp("[/.:]","g"),"_"),a=e.getElementsByTagName(n)[0];if(!e.getElementById(u)){if(s=e.createElement(n),s.id=u,s.src=i,t.isString(r)&&s.setAttribute(r,""),t.isObject(r))for(var c in r)s.setAttribute(c,r[c]);if(t.isArray(r))for(var h=0;h<r.length;h++)s.setAttribute(r[h],"");a.parentNode.insertBefore(s,a),s.readyState?s.onreadystatechange=function(){"loaded"!==s.readyState&&"complete"!==s.readyState||(s.onreadystatechange=null,o(i))}:s.onload=function(){o(i)}}};if(t.isString(e))i(document,"script",e,n);else{var o=0;t.forEach(e,function(t,r){i(document,"script",t,function(){o++>=e.length-1&&n(e)})})}}.bind(this))},d.prototype.run=function(){t.assign(t.templateSettings,this.templateSettings),this.router.attribute=this.attributes.route;var e=this.include(document.querySelectorAll("["+this.attributes.view+"]"));return e.then(function(){this.router.collect(document),this.router.listen()}.bind(this)),e},t.xng||(t.xng=new d),d});
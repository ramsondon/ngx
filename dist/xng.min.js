/*!
 * ramsondon.github.io - xng.js v3.0.0 (https://ramsondon.github.io/xng)
 * Copyright 2017 -2017 Matthias Schimd <ramsondon@gmail.com> (https://ramsondon.github.io)
 * Licensed under MIT (https://github.com/ramsondon/xng/blob/master/LICENSE)
 */
!function(t,e){"function"==typeof define&&define.amd?define(["lodash"],e):"object"==typeof exports?module.exports=e(require("lodash")):t.Xng=e(t._)}(this,function(t){var e=function(){"use strict";return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},n=function(e,i,r){"use strict";if(t.isObject(i)&&t.isUndefined(r))for(var o in i)n(e,o,i[o]);else t.isString(i)&&t.isFunction(r)&&(e[i]=r)},i=function(e,n,r){"use strict";t.isString(n)&&n in e?e[n](n,r):t.isArray(n)&&t.forEach(n,function(t){i(e,t,r)}),"*"in e&&e["*"](n,r)},r=function(){this.memory={}};r.prototype.hit=function(t){return t in this.memory},r.prototype.fault=function(t){return!this.hit(t)},r.prototype.put=function(t,e){this.memory[t]=e},r.prototype.get=function(t){if(this.hit(t))return this.memory[t];throw new Error("cache fault")};var o=function(){this.marker=new r,this.memory=new r};o.prototype.cache=function(e,n){return new Promise(function(i,r){var o=t.snakeCase(e);this.marker.fault()&&this.marker.put(o,n.fetch(e)),this.marker.get(o).then(function(t){this.memory.fault(o)&&this.memory.put(o,t),i(o)}.bind(this),function(t){console.warn("RESOURCE NOT FOUND: ",e,t),r(e,n)}).catch(function(){r(e,n)})}.bind(this))},o.prototype.get=function(t){return this.memory.get(t)};var s=function(t,e){"use strict";this.type=t||"text",this.url_prefix=e||""};s.prototype.parse=function(e){"use strict";return this.url_prefix.length>0?t.trimEnd(this.url_prefix,"/")+"/"+t.trimStart(e,"/"):e},s.prototype.fetch=function(t){return new Promise(function(e,n){var i=this.parse(t);fetch(i).then(function(t){if(200!==t.status)return console.warn("Error Report","Status Code: "+t.status,t.statusText),void n("Error Report","Status Code: "+t.status,t.statusText);t[this.type]().then(function(t){e(t)}.bind(this))}.bind(this),n).catch(function(t){n(t)}.bind(this))}.bind(this))};var u=function(t,e){this.el=t||document.createElement("div"),this.model=e||{$model:{}},this.afterRenderHtmlListeners={}};u.prototype.renderHtml=function(e){var n=document.createElement("script");n.type="text/x-xng-tpl",n.innerHTML=e,this.el.appendChild(n),this.el.innerHTML=t.template(this.el.innerHTML)(this.model),this.el.innerHTML=this.el.querySelector("script").innerHTML,i(this.afterRenderHtmlListeners,"all",{el:this.el,model:this.model})},u.prototype.afterRenderHtml=function(t){n(this.afterRenderHtmlListeners,"all",t)};var c=function(){this.attributes={view:"data-xng-view",model:"data-xng-model",listen:"data-xng-listen",route:"data-xng-route"},this.templateSettings={escape:/{{\\([\s\S]+?)}}/g,evaluate:/{%([\s\S]+?)%}/g,interpolate:/{{([\s\S]+?)}}/g},this.base_remote_dir="",this.current_route="",this.model_cache=new o,this.tpl_cache=new o,this.listeners={route:{},view:{}},this.errorTemplate='<div class="error"><h4>{{ $model.title }}</h4><p>{{ $model.message }}</p></div>'};return c.prototype.fetch=function(t,e){return new s(e,this.base_remote_dir).fetch(t)},c.prototype.render=function(e,n,r,o){return new Promise(function(c){var a=new u(r,n);a.afterRenderHtml(function(){var t=r.querySelectorAll("["+this.attributes.view+"]");this.include(t).then(function(){c(),i(this.listeners.view,o,r)}.bind(this))}.bind(this)),this.tpl_cache.cache(e,new s("text",this.base_remote_dir)).then(function(t){a.renderHtml(this.tpl_cache.get(t))}.bind(this),function(i,r){a.model=t.cloneDeep(n),a.model.$model={title:"Resource Not Found",message:"Resource "+e+" could not be loaded!"},a.renderHtml(this.errorTemplate),console.warn("Resource not found: ",e)}.bind(this)).catch(function(t){console.warn("error has been catched",t)})}.bind(this))},c.prototype.put=function(t,e,n){var r=document.querySelector(e);r.innerHTML=t,i(this.listeners.view,n,r)},c.prototype.guid=function(){var t=e;return[t()+t(),t(),t(),t(),t()+t()+t()].join("-")},c.prototype.parseDirectives=function(t){return{model:t.getAttribute(this.attributes.model),template:t.getAttribute(this.attributes.view),listener:t.getAttribute(this.attributes.listen)}},c.prototype.include=function(e){return new Promise(function(n){var i=0,r=function(t,r,o){this.render(t.template,{$route:this.current_route,$model:r},o,t.listener).then(function(){++i===e.length&&(n(),this.routing(o))}.bind(this))}.bind(this);t.forEach(e,function(t){var e=this.parseDirectives(t);if(e.model)try{r(e,this.readAssignment(e.model),t)}catch(n){this.model_cache.cache(e.model,new s("json",this.base_remote_dir)).then(function(n){r(e,this.model_cache.get(n),t)}.bind(this),function(n,i){r(e,{},t),console.warn("Model Resource not found: ",n)}.bind(this)).catch(function(t){console.warn(t)})}else r(e,null,t)}.bind(this)),e.length<=0&&n()}.bind(this))},c.prototype.nl2br=function(e,n){if(t.isString(e)){return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(n||void 0===n?"<br />":"<br>")+"$2")}return e},c.prototype.assign=function(e){return t.escape(JSON.stringify(e))},c.prototype.readAssignment=function(e){return JSON.parse(t.unescape(e))},c.prototype.base=function(t){return this.base_remote_dir=t,this},c.prototype.matches=function(e,n){var i=!1,r=function(e){var r=t.trimStart(n,"#");if((!e||"."===e)&&r.length<=0||e===r)return i=!0,!1};return t.isArray(e)?t.forEach(e,r):r(t.toString(e)),i},c.prototype.routing=function(e){var n="["+this.attributes.route+"]",r=e.querySelectorAll(n),o=null,s=null;t.forEach(r,function(e){var n=t.split(e.getAttribute(this.attributes.route),",").map(function(e){return t.trim(e)});o=t.find(".",n)||null===o?t.first(n):o,this.matches(n,window.location.hash)?(e.style.display="",s=window.location.hash,i(this.listeners.route,n)):e.style.display="none"}.bind(this)),null===s&&r.length>0&&(s=o,window.location.hash=o.replace(".","")),this.current_route=s},c.prototype.route=function(t,e){return n(this.listeners.route,t,e),this},c.prototype.listen=function(t,e){return n(this.listeners.view,t,e),this},c.prototype.require=function(e,n){return new Promise(function(i){var r=function(e,i,r,o){var s,u=r.replace(new RegExp("[/.:]","g"),"_"),c=e.getElementsByTagName(i)[0];if(!e.getElementById(u)){if(s=e.createElement(i),s.id=u,s.src=r,t.isString(n)&&s.setAttribute(n,""),t.isObject(n))for(var a in n)s.setAttribute(a,n[a]);if(t.isArray(n))for(var h=0;h<n.length;h++)s.setAttribute(n[h],"");c.parentNode.insertBefore(s,c),s.readyState?s.onreadystatechange=function(){"loaded"!==s.readyState&&"complete"!==s.readyState||(s.onreadystatechange=null,o(r))}:s.onload=function(){o(r)}}};if(t.isString(e))r(document,"script",e,i);else{var o=0;t.forEach(e,function(t,n){r(document,"script",t,function(){o++>=e.length-1&&i(e)})})}}.bind(this))},c.prototype.run=function(){t.assign(t.templateSettings,this.templateSettings);var e=this.include(document.querySelectorAll("["+this.attributes.view+"]"));return e.then(function(){window.onhashchange=function(){this.routing(document)}.bind(this)}.bind(this)),e},t.xng=new c,c});